# SmolVLA 12层视觉编码器配置更新

## 📌 重要发现

**SmolVLM2-500M-Video-Instruct 的视觉编码器实际只有 12 层，而非之前文档中的 27 层！**

---

## ✅ 已更新的内容

### 1. 文档更新
- ✅ `docs/SMOLVLA_VISION_LAYERS_GUIDE.md` - 已更新为12层版本
- ✅ `configs/policy/smolvla_sequential_base.yaml` - 已更新配置和注释

### 2. 层级功能重新划分（12层版本）

| 层级 | 包含层 | 功能 | 建议 |
|------|--------|------|------|
| **底层** | Layer 0-2 (3层，25%) | 边缘、纹理、基础形状 | ✅ 建议冻结 |
| **中底层** | Layer 3-5 (3层，25%) | 物体部件、材质识别 | 🔄 可选解冻 |
| **中高层** | Layer 6-8 (3层，25%) | 完整物体、空间关系 | ✅ 建议解冻 |
| **顶层** | Layer 9-11 (3层，25%) | 抓取点、动作关联、视觉-语言融合 | ✅ 必须解冻 |

---

## 🎯 推荐配置（基于你的2000 episodes）

### 当前默认配置（平衡策略）✅

```yaml
unfreeze_vision_layers: [-1, -2, -3, -4, -5, -6, -7, -8, -9]  # 解冻 Layer 3-11
```

**效果**：
- 🔒 冻结：Layer 0-2（3层，25%）
- 🔓 解冻：Layer 3-11（9层，75%）
- 📊 参数冻结：68.5M frozen，381M trainable

**适用场景**：✅ **非常适合你的2000 episodes！**

---

## 📋 其他可选策略

### 策略对比表

| 策略名称 | 解冻层数 | 配置 | 适用数据量 |
|---------|---------|------|-----------|
| **极保守** | 3-4层 | `[-1, -2, -3, -4]` | < 500 episodes |
| **保守** | 6层 | `[-1, -2, -3, -4, -5, -6]` | 500-1000 episodes |
| **平衡偏保守** | 8层 | `[-1, -2, -3, -4, -5, -6, -7, -8]` | 1000-1500 episodes |
| **平衡（当前）** | 9层 | `[-1, -2, -3, -4, -5, -6, -7, -8, -9]` | **1500-2500 episodes** ⭐ |
| **激进** | 10层 | `[-1, -2, -3, -4, -5, -6, -7, -8, -9, -10]` | 2500-4000 episodes |
| **极激进** | 11层 | 几乎全部解冻 | > 4000 episodes |

---

## 💡 配置建议

### 针对你的情况（2000 episodes）

**选项 1：保持当前配置（推荐）** ✅
```yaml
unfreeze_vision_layers: [-1, -2, -3, -4, -5, -6, -7, -8, -9]  # 解冻9层
```
- 优点：充分利用数据，75%参数可训练
- 适合：希望最大化性能

**选项 2：更保守一点**
```yaml
unfreeze_vision_layers: [-1, -2, -3, -4, -5, -6, -7, -8]  # 解冻8层
```
- 优点：更稳定，过拟合风险更低
- 适合：希望更稳定的训练

**选项 3：更激进一点**
```yaml
unfreeze_vision_layers: [-1, -2, -3, -4, -5, -6, -7, -8, -9, -10]  # 解冻10层
```
- 优点：最大化模型适应能力
- 适合：追求最高性能，可以接受较慢收敛

---

## 🎓 如何选择？

### 根据你的目标

| 目标 | 推荐策略 | 配置 |
|------|---------|------|
| **快速验证** | 保守（6层） | `[-1, -2, -3, -4, -5, -6]` |
| **稳定训练** | 平衡偏保守（8层） | `[-1, -2, -3, -4, -5, -6, -7, -8]` |
| **最佳性能** | 平衡（9层）⭐ | `[-1, -2, -3, -4, -5, -6, -7, -8, -9]` |
| **追求极致** | 激进（10层） | `[-1, -2, -3, -4, -5, -6, -7, -8, -9, -10]` |

---

## 📊 训练日志验证

从你的日志可以看到当前配置工作正常：

```
======================================================================
🔧 应用灵活视觉层冻结策略
======================================================================
Vision Encoder 总层数: 12

策略: 解冻指定层 [-1, -2, -3, -4, -5, -6, -7, -8, -9]

✅ 冻结策略应用完成:
   🔒 冻结层数: 3 / 12
   🔓 解冻层数: 9 / 12
   🔒 冻结层索引: [0, 1, 2]
   🔓 解冻层索引: [3, 4, 5, 6, 7, 8, 9, 10, 11]
======================================================================
```

---

## 🚀 下一步

### 1. 选择你的策略

编辑 `configs/policy/smolvla_sequential_base.yaml` 第64行：

```yaml
# 保持当前配置（推荐）
unfreeze_vision_layers: [-1, -2, -3, -4, -5, -6, -7, -8, -9]

# 或者选择其他策略（取消上面的注释，启用下面的）
# unfreeze_vision_layers: [-1, -2, -3, -4, -5, -6]  # 保守
# unfreeze_vision_layers: [-1, -2, -3, -4, -5, -6, -7, -8]  # 平衡偏保守
# unfreeze_vision_layers: [-1, -2, -3, -4, -5, -6, -7, -8, -9, -10]  # 激进
```

### 2. 开始训练

```bash
HF_ENDPOINT=http://hf.x-gpu.com python kuavo_train/train_smolvla_sequential.py \
    --config-path=../configs/policy \
    --config-name=smolvla_sequential_base
```

### 3. 监控训练效果

关注：
- 训练loss下降速度
- 验证loss（检查过拟合）
- 多任务验证结果

---

## 📚 参考文档

- **详细层级说明**：`docs/SMOLVLA_VISION_LAYERS_GUIDE.md`
- **快速开始**：`SMOLVLA_FLEXIBLE_FREEZING_QUICKSTART.md`
- **完整实现**：`SMOLVLA_FLEXIBLE_FREEZING_IMPLEMENTATION.md`

---

**更新日期**：2025-10-17
**版本**：v1.1 (12层版本)

