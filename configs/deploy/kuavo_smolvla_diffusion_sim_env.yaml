# ==================== Kuavo SmolVLA Diffusion 仿真环境部署配置 ====================
# 使用 Diffusion 版本的 SmolVLA 进行仿真部署

defaults:
  - _self_

# 环境配置
env:
  _target_: kuavo_sim_env.envs.kuavo_sim_env.KuavoSimEnv
  # 仿真服务器配置
  host: "localhost"
  port: 9090

  # 相机配置
  cameras:
    head_cam_h:
      width: 640
      height: 480
      fov: 90
    left_cam_l:
      width: 640
      height: 480
      fov: 90
    right_cam_r:
      width: 640
      height: 480
      fov: 90

# ==================== SmolVLA Diffusion 策略配置 ====================
policy:
  _target_: kuavo_train.wrapper.policy.smolvla.SmolVLADiffusionPolicyWrapper

  # 预训练模型路径
  pretrained_name_or_path: "outputs/train/task1_moving_grasp/smolvla_diffusion/best"

  # 推理配置（优化推理速度）
  inference:
    num_inference_steps: 20  # 推理步数（减少以提高速度）
    use_ddim_sampling: True  # 使用 DDIM 加速
    ddim_eta: 0.0  # 确定性采样

    # 批处理配置
    batch_size: 1  # 仿真通常使用 batch_size=1

    # 设备配置
    device: "cuda"  # 使用 GPU 加速

# ==================== 任务配置 ====================
task:
  # 任务描述（用于语言指令）
  name: "moving_grasp"
  description: "抓取传送带上的物品并精确放置到标记位置"

  # 语言指令
  language_instruction: "Grasp the object from the conveyor belt using visual guidance. Place it precisely at the first marked target location on the table. Then grasp it again and place it precisely at the second marked target location on the table."

  # 动作配置
  action:
    # 动作维度（Kuavo 双臂）
    action_dim: 16

    # 执行配置
    n_action_steps: 8  # 每次推理执行8步动作
    chunk_size: 50     # 动作序列长度

    # 频率配置
    control_frequency: 10  # 10Hz 控制频率
    observation_frequency: 30  # 30Hz 观测频率

# ==================== 观测配置 ====================
observation:
  # 图像观测
  images:
    - observation.images.h  # 头部相机
    - observation.images.l  # 左相机
    - observation.images.r  # 右相机

  # 深度观测
  depth:
    - observation.depth.h   # 头部深度
    - observation.depth.l   # 左深度
    - observation.depth.r   # 右深度

  # 状态观测
  state:
    - observation.state     # 16维关节状态

  # 夹爪状态
  gripper:
    - observation.gripper_state

# ==================== 数据预处理配置 ====================
preprocessing:
  # 图像预处理
  image:
    resize: [512, 512]  # SmolVLA 标准输入尺寸
    normalize: False    # SmolVLA 内部处理归一化

  # 深度预处理
  depth:
    resize: [512, 512]
    normalize_range: [0.0, 1000.0]

  # 状态预处理
  state:
    # 16维填充到32维（与预训练模型一致）
    padding: true
    target_dim: 32

# ==================== 推理优化配置 ====================
optimization:
  # 使用 torch.compile 加速（PyTorch 2.0+）
  use_compile: false  # 暂时关闭，可能会有兼容性问题

  # 使用半精度推理
  use_amp: true  # 使用自动混合精度

  # 模型缓存
  cache_model: true

  # 预热配置
  warmup_steps: 5  # 前5步不计入时间统计

# ==================== 安全配置 ====================
safety:
  # 关节限位
  joint_limits:
    enabled: true
    safety_margin: 0.05  # 5度安全边距

  # 速度限制
  velocity_limits:
    enabled: true
    max_velocity: 0.5  # rad/s

  # 力限制
  force_limits:
    enabled: true
    max_force: 100  # N

  # 碰撞检测
  collision_detection:
    enabled: true
    threshold: 0.01

# ==================== 日志和可视化配置 ====================
logging:
  # 日志级别
  level: "INFO"

  # 保存路径
  output_dir: "outputs/eval/smolvla_diffusion"

  # 保存数据
  save:
    observations: true
    actions: true
    rewards: true
    images: true

  # 可视化
  visualization:
    enabled: true
    show_camera_feeds: true
    show_trajectory: true

  # Wandb 配置
  wandb:
    enabled: false
    project: "kuavo-smolvla-diffusion"
    entity: null

# ==================== 评估配置 ====================
evaluation:
  # 评估轮数
  num_episodes: 10

  # 成功条件
  success_criteria:
    placement_tolerance: 0.05  # 5cm 位置容差
    orientation_tolerance: 0.2  # 约11度姿态容差

  # 超时配置
  timeout:
    per_episode: 120  # 每回合120秒超时
    per_step: 5      # 每步5秒超时

  # 指标计算
  metrics:
    - success_rate
    - placement_accuracy
    - action_smoothness
    - inference_time

# ==================== 调试配置 ====================
debug:
  # 调试模式
  enabled: false

  # 打印详细信息
  verbose: true

  # 保存中间结果
  save_intermediate: false

  # 可视化注意力
  visualize_attention: false

# ==================== 性能优化配置 ====================
performance:
  # 并行处理
  num_workers: 4

  # GPU 优化
  cuda:
    enabled: true
    memory_fraction: 0.8  # 使用80% GPU内存
    allow_growth: true

  # CPU 优化
  cpu:
    num_threads: 8
    affinity: null