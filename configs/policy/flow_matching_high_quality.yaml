# ==================== Flow Matching é«˜è´¨é‡é…ç½® ====================
# ä¼˜å…ˆè€ƒè™‘ç”Ÿæˆè´¨é‡ï¼Œé€‚åˆç¬¬ä¸€ç‰ˆæœ¬è®­ç»ƒå’Œç¦»çº¿è¯„ä¼°
# åŸºäº flow_matching_config.yamlï¼Œä½†é’ˆå¯¹è´¨é‡ä¼˜åŒ–

hydra:
  run:
    dir: ./outputs/train_hydra_save/singlerun/${now:%Y%m%d_%H%M%S}
  sweep:
    dir: ./outputs/train_hydra_save/multirun/${now:%Y%m%d_%H%M%S}
    subdir: ${hydra:job.override_dirname}

task: 'flow_matching_task_1'
method: 'flow_matching_high_quality' # é«˜è´¨é‡ç‰ˆæœ¬
timestamp: ${now:%Y%m%d_%H%M%S}
episodes_to_use:
  - 0
  - 999

repoid: 'lerobot/${task}'
root: '/root/robot/data/task-1/1-2000/lerobot/'

# è®­ç»ƒç›¸å…³é…ç½®
training:
  output_directory: 'outputs/train/${task}/${method}'
  seed: 42
  max_epoch: 500

  save_freq_epoch: 10
  log_freq: 1
  device: 'cuda'
  accumulation_steps: 1

  batch_size: 64
  num_workers: 12
  drop_last: False

  max_training_step: null
  resume: False

  # æ•°æ®å¢å¼ºé…ç½®ï¼ˆä¿æŒä¸å˜ï¼‰
  RGB_Augmenter:
    enable: True
    max_num_transforms: 1
    random_order: True
    tfs:
      notransform:
        weight: 2.0
        type: 'Identity'
        kwargs: {}
      brightness:
        weight: 1.0
        type: 'ColorJitter'
        kwargs: { 'brightness': [0.5, 1.5] }
      contrast:
        weight: 1.0
        type: 'ColorJitter'
        kwargs: { 'contrast': [0.5, 1.5] }
      saturation:
        weight: 1.0
        type: 'ColorJitter'
        kwargs: { 'saturation': [0.5, 1.5] }
      hue:
        weight: 1.0
        type: 'ColorJitter'
        kwargs: { 'hue': [-0.05, 0.05] }
      sharpness:
        weight: 1.0
        type: 'SharpnessJitter'
        kwargs: { 'sharpness': [0.5, 1.5] }
      random_mask:
        weight: 1.0
        type: RandomMask
        kwargs:
          mask_size: [0.1, 0.1]
      random_border_cutout:
        weight: 1.0
        type: RandomBorderCutout
        kwargs:
          cut_ratio: 0.15
      gaussian_noise:
        weight: 1.0
        type: GaussianNoise
        kwargs:
          mean: 0.0
          std: 0.05
      gamma_correction:
        weight: 1.0
        type: GammaCorrection
        kwargs:
          gamma: [0.5, 2.0]

policy_name: diffusion

policy:
  _target_: kuavo_train.wrapper.policy.diffusion.DiffusionConfigWrapper.CustomDiffusionConfigWrapper
  horizon: 16
  n_action_steps: 8
  drop_n_last_frames: 7

  normalization_mapping:
    RGB:
      _target_: lerobot.configs.types.NormalizationMode
      value: MEAN_STD
    DEPTH:
      _target_: lerobot.configs.types.NormalizationMode
      value: MIN_MAX

  crop_is_random: True
  crop_shape: [420, 560]
  use_amp: True

  # æ¨¡å‹è¶…å‚æ•°
  vision_backbone: resnet18
  spatial_softmax_num_keypoints: 64
  use_separate_rgb_encoder_per_camera: False

  down_dims:
    - 512
    - 1024
    - 2048
  kernel_size: 5
  n_groups: 8

  diffusion_step_embed_dim: 128
  use_film_scale_modulation: true

  # ==================== Flow Matching é«˜è´¨é‡é…ç½® ====================
  # ğŸ¯ ä¼˜å…ˆè´¨é‡é…ç½®
  use_flow_matching: True

  # ========== æ ¸å¿ƒå‚æ•°ï¼šä¼˜å…ˆè´¨é‡ ==========

  # 1. Flow Matching ç±»å‹ï¼šä½¿ç”¨æœ€æˆç†Ÿç¨³å®šçš„ conditional
  flow_matching_type: 'conditional'
  # è¯´æ˜: conditional æ˜¯æœ€ç¨³å®šçš„é€‰æ‹©ï¼Œç»è¿‡å……åˆ†éªŒè¯

  # 2. å™ªå£°æ°´å¹³ï¼šå®Œå…¨ç¡®å®šæ€§
  flow_sigma: 0.0
  # è¯´æ˜: 0.0 = å®Œå…¨ç¡®å®šæ€§ï¼Œæœ€é«˜è´¨é‡ï¼Œç»“æœå¯å¤ç°

  # 3. ODE æ±‚è§£å™¨ï¼šä½¿ç”¨é«˜ç²¾åº¦ RK4
  ode_solver: 'rk4'
  # è¯´æ˜: RK4 æ¯” Euler ç²¾ç¡®å¾—å¤šï¼Œä½†éœ€è¦ 4 å€å‰å‘ä¼ æ’­
  #       è´¨é‡ä¼˜å…ˆæ—¶æ¨èä½¿ç”¨

  # 4. æ¨ç†æ­¥æ•°ï¼šä½¿ç”¨è¾ƒå¤šæ­¥æ•°ä¿è¯è´¨é‡
  num_inference_steps: 30
  # è¯´æ˜: 30 æ­¥æä¾›é«˜è´¨é‡ç»“æœï¼Œæ¯” Diffusion çš„ 50-100 æ­¥ä»å¿«å¾ˆå¤š
  #       å¦‚æœè´¨é‡è¿˜ä¸å¤Ÿï¼Œå¯ä»¥å¢åŠ åˆ° 50

  # ==================== è´¨é‡ vs é€Ÿåº¦æƒè¡¡ ====================
  #
  # å½“å‰é…ç½®ï¼ˆè´¨é‡ä¼˜å…ˆï¼‰:
  #   - RK4 + 30 æ­¥ â‰ˆ 240ms/actionï¼ˆä¼°ç®—ï¼‰
  #   - è´¨é‡ï¼šâ­â­â­â­â­ (æœ€é«˜)
  #
  # å¦‚æœéœ€è¦å¹³è¡¡:
  #   - ode_solver: 'euler'
  #   - num_inference_steps: 20
  #   - â‰ˆ 40-50ms/action
  #   - è´¨é‡ï¼šâ­â­â­â­
  #
  # å¦‚æœéœ€è¦æé€Ÿ:
  #   - ode_solver: 'euler'
  #   - num_inference_steps: 10
  #   - â‰ˆ 20-25ms/action
  #   - è´¨é‡ï¼šâ­â­â­

  # ==================== åç»­ä¼˜åŒ–å»ºè®® ====================
  #
  # ç¬¬ä¸€é˜¶æ®µï¼ˆå½“å‰ - è´¨é‡éªŒè¯ï¼‰:
  #   âœ… ä½¿ç”¨é«˜è´¨é‡é…ç½®è®­ç»ƒ
  #   âœ… éªŒè¯ Flow Matching æ•ˆæœ
  #   âœ… å¯¹æ¯” Diffusion baseline
  #
  # ç¬¬äºŒé˜¶æ®µï¼ˆè´¨é‡ç¡®è®¤å - é€Ÿåº¦ä¼˜åŒ–ï¼‰:
  #   1. å°è¯•å‡å°‘æ¨ç†æ­¥æ•°: 30 â†’ 20 â†’ 15
  #   2. æµ‹è¯• Euler vs RK4 çš„è´¨é‡å·®å¼‚
  #   3. æ‰¾åˆ°æœ€ä½³çš„è´¨é‡-é€Ÿåº¦å¹³è¡¡ç‚¹
  #
  # ç¬¬ä¸‰é˜¶æ®µï¼ˆéƒ¨ç½²ä¼˜åŒ–ï¼‰:
  #   1. æ ¹æ®å®é™…ä»»åŠ¡éœ€æ±‚è°ƒæ•´
  #   2. å®æ—¶ä»»åŠ¡ï¼š10-15 æ­¥ + Euler
  #   3. ç¦»çº¿ä»»åŠ¡ï¼š30-50 æ­¥ + RK4

  # ä»¥ä¸‹ Diffusion å‚æ•°ä¿ç•™ä»¥å…¼å®¹
  noise_scheduler_type: DDPM
  num_train_timesteps: 100
  beta_schedule: squaredcos_cap_v2
  beta_start: 0.0001
  beta_end: 0.02
  prediction_type: epsilon
  clip_sample: true
  clip_sample_range: 1.0
  do_mask_loss_for_padding: false

  # optimizer and scheduler
  optimizer_lr: 0.0001
  optimizer_betas:
    - 0.95
    - 0.999
  optimizer_eps: 1.0e-08
  optimizer_weight_decay: 1.0e-03
  scheduler_name: cosine
  scheduler_warmup_steps: 500

  custom:
    # æ·±åº¦å›¾åƒæ”¯æŒ
    use_depth: True
    depth_backbone: resnet18
    use_separate_depth_encoder_per_camera: False

    # resize å’Œå¢å¼º
    resize_shape: [210, 280]

    # state encoder
    use_state_encoder: True
    state_feature_dim: 128

    # ç½‘ç»œæ¶æ„
    use_unet: False
    use_transformer: True
    transformer_n_emb: 512
    transformer_n_head: 8
    transformer_n_layer: 4
    transformer_dropout: 0.1
# ==================== ä½¿ç”¨è¯´æ˜ ====================
#
# 1. è®­ç»ƒå‘½ä»¤:
#    python train_policy.py policy=flow_matching_high_quality
#
# 2. é¢„æœŸæ•ˆæœ:
#    - è®­ç»ƒç¨³å®šæ€§: â­â­â­â­â­
#    - ç”Ÿæˆè´¨é‡: â­â­â­â­â­
#    - æ¨ç†é€Ÿåº¦: â­â­â­ (ä»æ¯” Diffusion å¿« 2-3 å€)
#
# 3. åç»­è°ƒæ•´:
#    å¦‚æœè´¨é‡å·²ç»å¾ˆå¥½ï¼Œæƒ³æé€Ÿï¼š
#      a. é™ä½æ¨ç†æ­¥æ•°: 30 â†’ 20
#      b. åˆ‡æ¢æ±‚è§£å™¨: rk4 â†’ euler
#
#    å¦‚æœè´¨é‡è¿˜ä¸å¤Ÿå¥½ï¼š
#      a. å¢åŠ æ¨ç†æ­¥æ•°: 30 â†’ 50
#      b. æ£€æŸ¥è®­ç»ƒæ˜¯å¦å……åˆ†æ”¶æ•›
#      c. å°è¯•å¢åŠ  flow_sigma (å¦‚ 0.001) å¢åŠ å¤šæ ·æ€§

