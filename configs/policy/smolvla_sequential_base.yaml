# ==================== SmolVLAé¡ºåºå¤šä»»åŠ¡è®­ç»ƒåŸºç¡€é…ç½® ====================
# è¿™æ˜¯æ‰€æœ‰4ä¸ªä»»åŠ¡å…±äº«çš„åŸºç¡€é…ç½®
# ä»»åŠ¡ç‰¹å®šé…ç½®åœ¨ configs/policy/tasks/ ç›®å½•ä¸‹

defaults:
  - _self_

# Hydraé…ç½®
hydra:
  run:
    dir: ./outputs/train_hydra_save/smolvla_sequential/${now:%Y%m%d_%H%M%S}
  sweep:
    dir: ./outputs/train_hydra_save/smolvla_sequential/multirun/${now:%Y%m%d_%H%M%S}
    subdir: ${hydra:job.override_dirname}

timestamp: ${now:%Y%m%d_%H%M%S}
method: 'smolvla_sequential'

# ä»»åŠ¡é…ç½®å­—æ®µï¼ˆHydraä¼šä»task configä¸­è¯»å–ï¼‰
# æ ¼å¼: task1_moving_grasp, task2_weighing, task3_placement, task4_sorting
task: 'task1_moving_grasp' # é»˜è®¤ä»»åŠ¡1ï¼Œä¼šè¢«ä»»åŠ¡é…ç½®è¦†ç›–

# ==================== SmolVLAç­–ç•¥é…ç½® ====================
policy_name: smolvla

policy:
  _target_: kuavo_train.wrapper.policy.smolvla.SmolVLAConfigWrapper

  # VLM Backboneé…ç½®
  vlm_model_name: 'HuggingFaceTB/SmolVLM2-500M-Video-Instruct' # ä½¿ç”¨é•œåƒæºä¸‹è½½
  load_vlm_weights: True # ä»»åŠ¡1ä»HuggingFaceé¢„è®­ç»ƒå¼€å§‹

  # å†»ç»“ç­–ç•¥
  freeze_vision_encoder: True
  train_expert_only: True
  train_state_proj: True # è®­ç»ƒstateæŠ•å½±å±‚

  # ==================== ğŸ†• çµæ´»çš„è§†è§‰å±‚å†»ç»“ç­–ç•¥ ====================
  # âš ï¸  SmolVLA (SmolVLM2-500M) è§†è§‰ç¼–ç å™¨å…± 12 å±‚ (Layer 0-11)
  # è¯¦ç»†è¯´æ˜è§ docs/SMOLVLA_VISION_LAYERS_GUIDE.md
  #
  # ğŸ“š å±‚çº§åŠŸèƒ½æ¦‚è¿°ï¼ˆ12å±‚ç‰ˆæœ¬ï¼‰ï¼š
  # - Layer 0-2:   åº•å±‚ï¼ˆ3å±‚ï¼Œ25%ï¼‰- é€šç”¨è§†è§‰ç‰¹å¾ï¼ˆè¾¹ç¼˜ã€çº¹ç†ã€å½¢çŠ¶ï¼‰      [å»ºè®®å†»ç»“]
  # - Layer 3-5:   ä¸­åº•å±‚ï¼ˆ3å±‚ï¼Œ25%ï¼‰- ç‰©ä½“éƒ¨ä»¶ã€æè´¨è¯†åˆ«              [å¯é€‰è§£å†»]
  # - Layer 6-8:   ä¸­é«˜å±‚ï¼ˆ3å±‚ï¼Œ25%ï¼‰- å®Œæ•´ç‰©ä½“ã€ç©ºé—´å…³ç³»              [å»ºè®®è§£å†»]
  # - Layer 9-11:  é¡¶å±‚ï¼ˆ3å±‚ï¼Œ25%ï¼‰- ä»»åŠ¡ç‰¹å®šç‰¹å¾ï¼ˆæŠ“å–ç‚¹ã€åŠ¨ä½œå…³è”ï¼‰  [å¿…é¡»è§£å†»]
  #
  # ğŸ¯ é…ç½®æ–¹å¼ï¼ˆä¸‰é€‰ä¸€ï¼Œä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰ï¼š
  #
  # æ–¹å¼1: unfreeze_vision_layers - æŒ‡å®šè¦è§£å†»çš„å±‚ï¼ˆæ¨èï¼‰
  #   æ”¯æŒè´Ÿæ•°ç´¢å¼•: -1è¡¨ç¤ºæœ€åä¸€å±‚, -2è¡¨ç¤ºå€’æ•°ç¬¬äºŒå±‚
  #   ç¤ºä¾‹: [-1, -2, -3, -4, -5] è¡¨ç¤ºè§£å†»æœ€å5å±‚
  #
  # æ–¹å¼2: freeze_vision_layers - æŒ‡å®šè¦å†»ç»“çš„å±‚
  #   ç¤ºä¾‹: [0, 1, 2, 3, 4, 5, 6, 7, 8] è¡¨ç¤ºå†»ç»“å‰9å±‚
  #
  # æ–¹å¼3: freeze_vision_ratio - æŒ‰æ¯”ä¾‹å†»ç»“å‰N%çš„å±‚ï¼ˆæœ€ç®€å•ï¼‰
  #   ç¤ºä¾‹: 0.75 è¡¨ç¤ºå†»ç»“å‰75%çš„å±‚ï¼ˆå‰20å±‚ï¼‰
  #
  # âš ï¸  æ³¨æ„ï¼šå¦‚æœä¸é…ç½®ä»¥ä¸‹ä»»ä½•é€‰é¡¹ï¼Œå°†ä½¿ç”¨ freeze_vision_encoder çš„é»˜è®¤è¡Œä¸º

  # ğŸ¯ é»˜è®¤ç­–ç•¥ï¼šå¹³è¡¡ç­–ç•¥ï¼ˆè§£å†»9å±‚ï¼Œé€‚åˆ1500-2500 episodesï¼‰
  # å†»ç»“å‰3å±‚ï¼ˆ25%ï¼‰ï¼Œè§£å†»å9å±‚ï¼ˆ75%ï¼‰
  # unfreeze_vision_layers: [-1, -2, -3, -4, -5, -6, -7, -8, -9] # è§£å†» Layer 3-11
  unfreeze_vision_layers: null

  # ğŸ“‹ å…¶ä»–å¯é€‰ç­–ç•¥ï¼ˆæ ¹æ®æ•°æ®é‡é€‰æ‹©ï¼Œå–æ¶ˆæ³¨é‡Šä½¿ç”¨ï¼‰ï¼š
  #
  # ğŸ”¹ ä¿å®ˆç­–ç•¥ï¼ˆé€‚åˆ<1000 episodesï¼‰:
  # unfreeze_vision_layers: [-1, -2, -3, -4, -5, -6]  # è§£å†»å6å±‚ï¼ˆLayer 6-11ï¼‰
  # freeze_vision_ratio: 0.5  # æˆ–ç”¨æ¯”ä¾‹ï¼šå†»ç»“å‰50%
  #
  # ğŸ”¹ å¹³è¡¡åä¿å®ˆç­–ç•¥ï¼ˆé€‚åˆ1000-1500 episodesï¼‰:
  # unfreeze_vision_layers: [-1, -2, -3, -4, -5, -6, -7, -8]  # è§£å†»å8å±‚ï¼ˆLayer 4-11ï¼‰
  #
  # ğŸ”¹ æ¿€è¿›ç­–ç•¥ï¼ˆé€‚åˆ>2500 episodesï¼‰:
  # unfreeze_vision_layers: [-1, -2, -3, -4, -5, -6, -7, -8, -9, -10]  # è§£å†»å10å±‚ï¼ˆLayer 2-11ï¼‰
  # freeze_vision_ratio: 0.17  # æˆ–ç”¨æ¯”ä¾‹ï¼šå†»ç»“å‰17%
  #
  # ğŸ”¹ ææ¿€è¿›ç­–ç•¥ï¼ˆé€‚åˆ>4000 episodesï¼Œå‡ ä¹å…¨éƒ¨è§£å†»ï¼‰:
  # unfreeze_vision_layers: [-1, -2, -3, -4, -5, -6, -7, -8, -9, -10, -11]  # è§£å†»11å±‚ï¼ˆLayer 1-11ï¼‰
  #
  # ğŸ”¹ ç²¾å‡†ç­–ç•¥ï¼ˆåªè§£å†»é¡¶å±‚å’Œä¸­é«˜å±‚ï¼‰:
  # unfreeze_vision_layers: [6, 7, 8, 9, 10, 11]  # è§£å†»ä¸­é«˜å±‚+é¡¶å±‚ï¼ˆ6å±‚ï¼‰

  # è§‚æµ‹é…ç½®
  n_obs_steps: 1 # ä½¿ç”¨å½“å‰å¸§ï¼ˆSmolVLAæ ‡å‡†ï¼‰

  # åŠ¨ä½œç©ºé—´é…ç½®ï¼ˆKuavoåŒè‡‚16å…³èŠ‚æœºå™¨äººï¼‰
  # æ³¨æ„ï¼šä¸ºäº†ä½¿ç”¨SmolVLAé¢„è®­ç»ƒæƒé‡ï¼Œstate/actionç»´åº¦å¿…é¡»ä¸é¢„è®­ç»ƒæ¨¡å‹ä¸€è‡´ï¼ˆ32ç»´ï¼‰
  # Kuavoçš„16ç»´æ•°æ®ä¼šåœ¨æ•°æ®åŠ è½½æ—¶è‡ªåŠ¨å¡«å……åˆ°32ç»´ï¼ˆå16ç»´å¡«0ï¼‰
  max_state_dim: 32 # ä½¿ç”¨é¢„è®­ç»ƒæ¨¡å‹çš„32ç»´çŠ¶æ€ç©ºé—´
  max_action_dim: 32 # ä½¿ç”¨é¢„è®­ç»ƒæ¨¡å‹çš„32ç»´åŠ¨ä½œç©ºé—´
  chunk_size: 50 # åŠ¨ä½œåºåˆ—é•¿åº¦ï¼ˆFlow Matchingç”Ÿæˆ50æ­¥ï¼‰
  n_action_steps: 8 # æ¯æ¬¡æ‰§è¡Œ8æ­¥åŠ¨ä½œï¼ˆä¸Diffusionç­–ç•¥ä¸€è‡´ï¼‰

  # å›¾åƒé¢„å¤„ç†é…ç½®
  resize_imgs_with_padding: [512, 512] # SmolVLAæ ‡å‡†è¾“å…¥å°ºå¯¸
  empty_cameras: 0 # ä¸ä½¿ç”¨ç©ºç›¸æœºå ä½

  # æ·±åº¦ç›¸æœºæ”¯æŒé…ç½®
  use_depth: True # å¯ç”¨æ·±åº¦ç›¸æœºæ”¯æŒ
  depth_features:
    - 'observation.depth_h'
    - 'observation.depth_l'
    - 'observation.depth_r'
  depth_resize_with_padding: [512, 512] # æ·±åº¦å›¾åƒç›®æ ‡å°ºå¯¸
  depth_normalization_range: [0.0, 1000.0] # æ·±åº¦å€¼å½’ä¸€åŒ–èŒƒå›´
  use_depth_padding: True # æ·±åº¦å›¾ä½¿ç”¨paddingæ–¹å¼ä¿æŒé•¿å®½æ¯” (æ¨èç”¨äºé«˜ç²¾åº¦ä»»åŠ¡)

  # Flow Matchingé…ç½®ï¼ˆSmolVLAä½¿ç”¨Flow Matchingè€ŒéDiffusionï¼‰
  num_steps: 50 # æ¨ç†æ—¶çš„å»å™ªæ­¥æ•°

  # å½’ä¸€åŒ–é…ç½®
  normalization_mapping:
    VISUAL:
      _target_: lerobot.configs.types.NormalizationMode
      value: IDENTITY # SmolVLAå†…éƒ¨å¤„ç†å›¾åƒå½’ä¸€åŒ–
    STATE:
      _target_: lerobot.configs.types.NormalizationMode
      value: MEAN_STD
    ACTION:
      _target_: lerobot.configs.types.NormalizationMode
      value: MEAN_STD

  # ä¼˜åŒ–å™¨åŸºç¡€é…ç½®ï¼ˆå„ä»»åŠ¡ä¼šoverrideå­¦ä¹ ç‡ï¼‰
  # é’ˆå¯¹batch_size=64ä¼˜åŒ–çš„å‚æ•°
  optimizer_betas: [0.9, 0.999] # beta2=0.999å¯¹è¾ƒå¤§batchæ›´ç¨³å®š
  optimizer_eps: 1.0e-08
  optimizer_weight_decay: 1.0e-6 # å¢åŠ æ­£åˆ™åŒ–ï¼Œé˜²æ­¢è¿‡æ‹Ÿåˆ
  optimizer_grad_clip_norm: 0.5 # é™ä½æ¢¯åº¦è£å‰ªé˜ˆå€¼ï¼Œä¿æŠ¤é¢„è®­ç»ƒæƒé‡

  # åˆ†å±‚å­¦ä¹ ç‡é…ç½®ï¼ˆè§£é”VLMåä½¿ç”¨ï¼‰
  use_layerwise_lr: True # å¯ç”¨åˆ†å±‚å­¦ä¹ ç‡
  vision_encoder_lr: 5.0e-6 # è§†è§‰ç¼–ç å™¨å­¦ä¹ ç‡ï¼ˆéå¸¸ä½ï¼Œä¿æŠ¤é¢„è®­ç»ƒæƒé‡ï¼‰
  expert_lr: 2.0e-5 # Action Expertå­¦ä¹ ç‡ï¼ˆç›¸å¯¹è¾ƒé«˜ï¼‰

  # å­¦ä¹ ç‡è°ƒåº¦å™¨é…ç½®ï¼ˆå„ä»»åŠ¡ä¼šoverrideï¼‰
  scheduler_warmup_steps: 3000 # è§£é”VLMåéœ€è¦æ›´é•¿warmup
  scheduler_decay_steps: 35000 # æ›´é•¿çš„è¡°å‡å‘¨æœŸ
  scheduler_decay_lr: 1e-6 # æœ€ç»ˆå­¦ä¹ ç‡è¡°å‡åˆ°å¾ˆå°

# ==================== è®­ç»ƒåŸºç¡€é…ç½® ====================
training:
  output_directory: 'outputs/train/${task}/${method}' # ä¸å…¶ä»–ç­–ç•¥ä¸€è‡´çš„è·¯å¾„æ ¼å¼
  device: 'cuda'
  seed: 42

  # åŠ¨ä½œç»´åº¦é€‚é…é…ç½®
  target_action_dim: 32 # ç›®æ ‡åŠ¨ä½œç»´åº¦ï¼ˆä¸é¢„è®­ç»ƒæ¨¡å‹ä¸€è‡´ï¼‰

  # æ•°æ®åŠ è½½ï¼ˆè§£é”VLMåéœ€è¦é™ä½batch_sizeï¼‰
  batch_size: 64
  num_workers: 14
  drop_last: True
  prefetch_factor: 2 # å¢åŠ é¢„å–ï¼Œæé«˜GPUåˆ©ç”¨ç‡
  persistent_workers: True # ä¿æŒworkerè¿›ç¨‹ï¼Œå‡å°‘é‡å¯å¼€é”€

  # æ—¥å¿—å’Œä¿å­˜
  save_freq_epoch: 3 # æ›´é¢‘ç¹ä¿å­˜checkpoint
  log_freq: 50 # å‡å°‘æ—¥å¿—IOå¼€é”€ï¼Œæ¯50æ­¥è®°å½•ä¸€æ¬¡

  # å¤šä»»åŠ¡éªŒè¯é…ç½®ï¼ˆé˜²é—å¿˜çš„å…³é”®ï¼‰
  validate_all_previous_tasks: True
  validation_freq_epoch: 2 # æ¯2ä¸ªepochéªŒè¯æ‰€æœ‰ä¹‹å‰çš„ä»»åŠ¡
  validation_episodes: 20 # æ›´å¤šéªŒè¯episodesï¼Œè¯„ä¼°æ›´å‡†ç¡®

  # ==================== RGBæ•°æ®å¢å¹¿é…ç½® ====================
  # å‚è€ƒDiffusionç­–ç•¥çš„å¢å¹¿æ–¹å¼ï¼Œä½†é’ˆå¯¹é¢„è®­ç»ƒVLMé€‚åº¦è°ƒæ•´
  # SmolVLAä½¿ç”¨é¢„è®­ç»ƒçš„SigLIPè§†è§‰ç¼–ç å™¨ï¼Œå¢å¹¿ä¸å®œè¿‡åº¦æ¿€è¿›
  RGB_Augmenter:
    enable: True # å¯ç”¨æ•°æ®å¢å¹¿
    max_num_transforms: 1 # æ¯æ¬¡æœ€å¤šåº”ç”¨1ä¸ªå˜æ¢ï¼ˆæ¯”Diffusionçš„1æ›´ä¿å®ˆï¼‰
    random_order: True # éšæœºé¡ºåºåº”ç”¨
    tfs:
      notransform:
        weight: 2.0 # 40%çš„æ—¶å€™ä¸åšä»»ä½•å˜æ¢ï¼ˆä¿æŠ¤é¢„è®­ç»ƒçŸ¥è¯†ï¼‰
        type: 'Identity'
        kwargs: {}
      brightness:
        weight: 1.0 # äº®åº¦è°ƒæ•´ï¼ˆç›¸å¯¹æ¸©å’Œï¼‰
        type: 'ColorJitter'
        kwargs: { 'brightness': [0.7, 1.3] } # æ¯”Diffusionçš„[0.5,1.5]æ›´ä¿å®ˆ
      contrast:
        weight: 1.0 # å¯¹æ¯”åº¦è°ƒæ•´
        type: 'ColorJitter'
        kwargs: { 'contrast': [0.7, 1.3] }
      saturation:
        weight: 0.8 # é¥±å’Œåº¦è°ƒæ•´ï¼ˆæƒé‡ç¨ä½ï¼‰
        type: 'ColorJitter'
        kwargs: { 'saturation': [0.7, 1.3] }
      hue:
        weight: 0.5 # è‰²è°ƒè°ƒæ•´ï¼ˆæƒé‡æ›´ä½ï¼Œé¢„è®­ç»ƒæ¨¡å‹å¯¹é¢œè‰²æ•æ„Ÿï¼‰
        type: 'ColorJitter'
        kwargs: { 'hue': [-0.03, 0.03] } # æ¯”Diffusionçš„[-0.05,0.05]æ›´ä¿å®ˆ
      sharpness:
        weight: 0.8 # é”åº¦è°ƒæ•´
        type: 'SharpnessJitter'
        kwargs: { 'sharpness': [0.7, 1.3] }
      gaussian_noise:
        weight: 0.5 # é«˜æ–¯å™ªå£°ï¼ˆæƒé‡è¾ƒä½ï¼Œé¿å…ç ´åè§†è§‰ç‰¹å¾ï¼‰
        type: GaussianNoise
        kwargs:
          mean: 0.0
          std: 0.03 # æ¯”Diffusionçš„0.05æ›´å°
      gamma_correction:
        weight: 0.8 # ä¼½é©¬æ ¡æ­£ï¼ˆæ¨¡æ‹Ÿå…‰ç…§å˜åŒ–ï¼‰
        type: GammaCorrection
        kwargs:
          gamma: [0.7, 1.3] # æ¯”Diffusionçš„[0.5,2.0]æ›´ä¿å®ˆ
      # æ³¨æ„ï¼šä¸ä½¿ç”¨ random_mask å’Œ random_border_cutout
      # å› ä¸ºè¿™äº›ä¼šç ´åå›¾åƒå®Œæ•´æ€§ï¼Œå¯¹é¢„è®­ç»ƒVLMä¸å‹å¥½

# ==================== é¡ºåºè®­ç»ƒç­–ç•¥é…ç½® ====================
sequential:
  # æ˜¯å¦ä½¿ç”¨Replay Bufferï¼ˆé˜²é—å¿˜çš„æ ¸å¿ƒæŠ€æœ¯ï¼‰
  use_replay_buffer: True
  replay_strategy: 'proportional' # æ¯”ä¾‹æ··åˆç­–ç•¥

  # Stage 2: è®­ç»ƒä»»åŠ¡2æ—¶çš„æ•°æ®æ··åˆæ¯”ä¾‹
  stage2_replay:
    task1: 0.2 # 20% ä»»åŠ¡1æ•°æ®
    task2: 0.8 # 80% ä»»åŠ¡2æ•°æ®

  # Stage 3: è®­ç»ƒä»»åŠ¡3æ—¶çš„æ•°æ®æ··åˆæ¯”ä¾‹
  stage3_replay:
    task1: 0.1 # 10% ä»»åŠ¡1æ•°æ®
    task2: 0.2 # 20% ä»»åŠ¡2æ•°æ®
    task3: 0.7 # 70% ä»»åŠ¡3æ•°æ®

  # Stage 4: è®­ç»ƒä»»åŠ¡4æ—¶çš„æ•°æ®æ··åˆæ¯”ä¾‹ï¼ˆæœ€ç»ˆå¤šä»»åŠ¡æ¨¡å‹ï¼‰
  stage4_replay:
    task1: 0.1 # 10% ä»»åŠ¡1æ•°æ®
    task2: 0.1 # 10% ä»»åŠ¡2æ•°æ®
    task3: 0.2 # 20% ä»»åŠ¡3æ•°æ®
    task4: 0.6 # 60% ä»»åŠ¡4æ•°æ®
