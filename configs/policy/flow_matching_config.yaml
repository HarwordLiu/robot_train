# ==================== Flow Matching é…ç½®ç¤ºä¾‹ ====================
# åŸºäº diffusion_config.yamlï¼Œä½†å¯ç”¨äº† Flow Matching
# Flow Matching æä¾› 3-10å€ çš„æ¨ç†é€Ÿåº¦æå‡ï¼ŒåŒæ—¶ä¿æŒç›¸å½“çš„æ€§èƒ½

hydra:
  run:
    dir: ./outputs/train_hydra_save/singlerun/${now:%Y%m%d_%H%M%S}
  sweep:
    dir: ./outputs/train_hydra_save/multirun/${now:%Y%m%d_%H%M%S}
    subdir: ${hydra:job.override_dirname}

task: 'task_300_episodes'
method: 'flow_matching_bs64_usedepth' # ä¿®æ”¹æ–¹æ³•åä»¥åŒºåˆ†
timestamp: ${now:%Y%m%d_%H%M%S}
episodes_to_use:
  - 0
  - 199

repoid: 'lerobot/${task}'
root: '/root/robot/data/task1/data/lerobot/1-400/'

# è®­ç»ƒç›¸å…³é…ç½®
training:
  output_directory: 'outputs/train/${task}/${method}'
  seed: 42
  max_epoch: 500

  save_freq_epoch: 10
  log_freq: 1
  device: 'cuda'
  accumulation_steps: 1
  ema_power: 0.75

  batch_size: 96
  num_workers: 16
  drop_last: False

  max_training_step: null

  resume: True
  resume_timestamp: 'run_20251011_112255'

  # æ•°æ®å¢å¹¿é…ç½®ï¼ˆä¸ Diffusion ç›¸åŒï¼‰
  RGB_Augmenter:
    enable: True
    max_num_transforms: 1
    random_order: True
    tfs:
      notransform:
        weight: 2.0
        type: 'Identity'
        kwargs: {}
      brightness:
        weight: 1.0
        type: 'ColorJitter'
        kwargs: { 'brightness': [0.5, 1.5] }
      contrast:
        weight: 1.0
        type: 'ColorJitter'
        kwargs: { 'contrast': [0.5, 1.5] }
      saturation:
        weight: 1.0
        type: 'ColorJitter'
        kwargs: { 'saturation': [0.5, 1.5] }
      hue:
        weight: 1.0
        type: 'ColorJitter'
        kwargs: { 'hue': [-0.05, 0.05] }
      sharpness:
        weight: 1.0
        type: 'SharpnessJitter'
        kwargs: { 'sharpness': [0.5, 1.5] }
      random_mask:
        weight: 1.0
        type: RandomMask
        kwargs:
          mask_size: [0.1, 0.1]
      random_border_cutout:
        weight: 1.0
        type: RandomBorderCutout
        kwargs:
          cut_ratio: 0.15
      gaussian_noise:
        weight: 1.0
        type: GaussianNoise
        kwargs:
          mean: 0.0
          std: 0.05
      gamma_correction:
        weight: 1.0
        type: GammaCorrection
        kwargs:
          gamma: [0.5, 2.0]

policy_name: diffusion # ä¿æŒä¸å˜ï¼Œä½¿ç”¨ç›¸åŒçš„ Policy ç±»

policy:
  _target_: kuavo_train.wrapper.policy.diffusion.DiffusionConfigWrapper.CustomDiffusionConfigWrapper
  horizon: 16
  n_action_steps: 8
  drop_n_last_frames: 7

  normalization_mapping:
    RGB:
      _target_: lerobot.configs.types.NormalizationMode
      value: MEAN_STD
    DEPTH:
      _target_: lerobot.configs.types.NormalizationMode
      value: MIN_MAX

  crop_is_random: True
  crop_shape: [420, 560]

  use_amp: True

  # æ¨¡å‹è¶…å‚æ•°
  vision_backbone: resnet18
  spatial_softmax_num_keypoints: 64
  use_separate_rgb_encoder_per_camera: False

  down_dims:
    - 512
    - 1024
    - 2048
  kernel_size: 5
  n_groups: 8

  diffusion_step_embed_dim: 128
  use_film_scale_modulation: true

  # ==================== Flow Matching é…ç½® ====================
  # ğŸŒŠ å¯ç”¨ Flow Matching
  use_flow_matching: True # âœ… å…³é”®å¼€å…³

  # Flow Matching å‚æ•°
  flow_matching_type: 'conditional' # é€‰é¡¹: conditional, optimal_transport, rectified
  flow_sigma: 0.0 # å™ªå£°æ°´å¹³ï¼ˆ0=å®Œå…¨ç¡®å®šæ€§ï¼‰
  ode_solver: 'euler' # ODEæ±‚è§£å™¨: euler (å¿«) æˆ– rk4 (ç²¾ç¡®)

  # æ¨ç†æ­¥æ•°ï¼ˆFlow Matching åªéœ€ 10-20 æ­¥ï¼‰
  num_inference_steps: 10 # âš¡ ä» 50-100 é™åˆ° 10ï¼Œé€Ÿåº¦æå‡ 5-10å€

  # ä»¥ä¸‹ Diffusion å‚æ•°åœ¨ Flow Matching æ¨¡å¼ä¸‹ä¸ä½¿ç”¨ï¼Œä½†ä¿ç•™ä»¥å…¼å®¹
  noise_scheduler_type: DDPM
  num_train_timesteps: 100
  beta_schedule: squaredcos_cap_v2
  beta_start: 0.0001
  beta_end: 0.02
  prediction_type: epsilon
  clip_sample: true
  clip_sample_range: 1.0
  do_mask_loss_for_padding: false

  # optimizer and scheduler
  optimizer_lr: 0.0001
  optimizer_betas:
    - 0.95
    - 0.999
  optimizer_eps: 1.0e-08
  optimizer_weight_decay: 1.0e-03
  scheduler_name: cosine
  scheduler_warmup_steps: 500

  custom:
    # æ·±åº¦å›¾åƒæ”¯æŒ
    use_depth: True
    depth_backbone: resnet18
    use_separate_depth_encoder_per_camera: False

    # resize å’Œå¢å¼º
    resize_shape: [210, 280]

    # state encoder
    use_state_encoder: True
    state_feature_dim: 128

    # ç½‘ç»œæ¶æ„é€‰æ‹©
    use_unet: False
    use_transformer: True
    transformer_n_emb: 512
    transformer_n_head: 8
    transformer_n_layer: 4
    transformer_dropout: 0.1
# ==================== æ€§èƒ½å¯¹æ¯”å‚è€ƒ ====================
#
# | æŒ‡æ ‡           | Diffusion (DDPM) | Flow Matching   |
# |----------------|------------------|-----------------|
# | æ¨ç†æ­¥æ•°       | 50-100æ­¥         | 10-20æ­¥ âš¡      |
# | æ¨ç†æ—¶é—´       | ~200ms/action    | ~40ms/action ğŸš€ |
# | è®­ç»ƒç¨³å®šæ€§     | â­â­â­â­         | â­â­â­â­â­      |
# | ç”Ÿæˆè´¨é‡       | â­â­â­â­â­       | â­â­â­â­â­      |
# | å®æ—¶æ§åˆ¶é€‚ç”¨   | ä¸€èˆ¬             | ä¼˜ç§€ âœ…         |
#
# ==================== ä½¿ç”¨å»ºè®® ====================
#
# 1. é¦–æ¬¡è®­ç»ƒå»ºè®®:
#    - ä½¿ç”¨é»˜è®¤é…ç½® (conditional flow matching + euler solver)
#    - num_inference_steps = 10
#    - ç›‘æ§è®­ç»ƒæŸå¤±æ›²çº¿
#
# 2. æ€§èƒ½è°ƒä¼˜:
#    - å¦‚éœ€æ›´é«˜ç²¾åº¦: ode_solver = "rk4"
#    - å¦‚éœ€æ›´å¿«æ¨ç†: num_inference_steps = 5
#    - å¦‚éœ€éšæœºæ€§: flow_sigma = 0.01
#
# 3. é«˜çº§é€‰é¡¹:
#    - optimal_transport: ç†è®ºä¸Šæ›´ä¼˜ï¼Œä½†è®¡ç®—å¤æ‚
#    - rectified: éœ€è¦å¤šæ¬¡è®­ç»ƒä¿®æ­£
#
# ==================== åˆ‡æ¢å› Diffusion ====================
#
# å¦‚æœæƒ³åˆ‡æ¢å›ä¼ ç»Ÿ Diffusionï¼Œåªéœ€ä¿®æ”¹:
#   use_flow_matching: False
#   num_inference_steps: 50  # æˆ– 100

